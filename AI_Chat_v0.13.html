<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI èšåˆæ§åˆ¶å° (V13.0 æ™‚å…‰æ©Ÿç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --chat-bg: #ffffff;
            --primary-color: #007bff;
            --user-msg-bg: #007bff;
            --user-msg-text: #ffffff;
            --ai-msg-bg: #f8f9fa;
            --ai-msg-text: #333333;
            --border-color: #e5e5e5;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: var(--bg-color); display: flex; justify-content: center; height: 100vh; }
        .main-container { width: 100%; max-width: 900px; background: var(--chat-bg); display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.05); height: 100%; }
        
        /* Header */
        .header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: #fff; z-index: 10; }
        .header-left h1 { margin: 0; font-size: 1.1rem; color: #333; font-weight: 600; }
        .header-actions { display: flex; gap: 8px; }
        .btn { background: white; border: 1px solid #ddd; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; color: #555; }
        .btn:hover { background: #f5f5f5; border-color: #ccc; }
        .btn-reset { font-size: 0.7rem; color: #adb5bd; border: none; background: none; padding: 2px 5px; margin-left: 5px;}
        .btn-reset:hover { color: #dc3545; }
        .btn-load { border-color: #28a745; color: #28a745; }
        .btn-load:hover { background: #e6ffed; }

        /* Chat Area */
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; scroll-behavior: smooth; }
        .message-container { display: flex; flex-direction: column; gap: 4px; max-width: 85%; }
        .message-container.user { align-self: flex-end; align-items: flex-end; }
        .message-container.ai { align-self: flex-start; align-items: flex-start; }
        .message-container.system { align-self: center; max-width: 95%; }

        .message { padding: 12px 16px; border-radius: 12px; line-height: 1.6; word-wrap: break-word; font-size: 0.95rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .message.user { background-color: var(--user-msg-bg); color: var(--user-msg-text); border-bottom-right-radius: 2px; }
        .message.ai { background-color: var(--ai-msg-bg); color: var(--ai-msg-text); border: 1px solid #eee; border-bottom-left-radius: 2px; }
        .message.system { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; font-size: 0.85rem; padding: 8px 15px; border-radius: 20px; text-align: center; }

        .message pre { background: #2b2b2b; color: #f8f8f2; padding: 12px; border-radius: 8px; overflow-x: auto; margin: 8px 0; }
        .message code { font-family: monospace; font-size: 0.9em; }
        
        .github-btn { font-size: 0.75rem; color: #586069; background-color: #f3f4f6; border: 1px solid rgba(27,31,35,.15); border-radius: 4px; padding: 2px 8px; cursor: pointer; margin-top: 4px; display: inline-flex; align-items: center; transition: 0.2s; }
        .github-btn:hover { background-color: #e6ebf1; color: #24292e; }

        /* Input Area */
        .input-area-wrapper { padding: 15px 20px 20px 20px; background: #fff; border-top: 1px solid var(--border-color); position: relative; }
        .input-controls { display: flex; align-items: center; margin-bottom: 8px; justify-content: space-between; }
        
        #quick-model-btn {
            display: flex; align-items: center; gap: 6px;
            background: #f8f9fa; border: 1px solid #e9ecef;
            padding: 4px 10px; border-radius: 20px;
            font-size: 0.8rem; font-weight: 500; color: #495057;
            cursor: pointer; transition: all 0.2s;
        }
        #quick-model-btn:hover { background: #e9ecef; border-color: #dee2e6; color: #212529; }
        
        .provider-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .dot-google { background: #fd7e14; }
        .dot-zhipu { background: #007bff; }
        .dot-claude { background: #d946ef; }
        .dot-universal { background: #20c997; }

        .input-box-container { display: flex; gap: 10px; align-items: flex-end; }
        textarea { flex: 1; padding: 12px; border-radius: 12px; border: 1px solid #ddd; resize: none; height: 50px; font-size: 1rem; outline: none; transition: border 0.2s; font-family: inherit; }
        textarea:focus { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(0,123,255,0.1); }
        button#send-btn { height: 46px; padding: 0 20px; background-color: var(--primary-color); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; }
        button#send-btn:disabled { background-color: #ccc; cursor: not-allowed; }

        /* Quick Menu */
        #quick-model-menu { display: none; position: absolute; bottom: 90px; left: 20px; background: white; border: 1px solid rgba(0,0,0,0.1); border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); width: 260px; max-height: 350px; overflow-y: auto; z-index: 100; padding: 5px; }
        .quick-menu-item { padding: 8px 12px; font-size: 0.9rem; color: #333; cursor: pointer; border-radius: 6px; display: flex; align-items: center; gap: 8px; }
        .quick-menu-item:hover { background: #f1f3f5; }
        .quick-menu-item.active { background: #e7f5ff; color: #007bff; font-weight: bold; }
        .quick-menu-header { font-size: 0.75rem; color: #888; padding: 5px 10px; margin-top: 5px; font-weight: bold; border-top: 1px solid #eee; }
        .quick-menu-header:first-child { border-top: none; margin-top: 0; }

        /* Settings Modal */
        #settings-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(2px); }
        .modal-content { background: white; padding: 25px; border-radius: 16px; width: 90%; max-width: 480px; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        
        /* File Browser Modal */
        #file-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); justify-content: center; align-items: center; z-index: 1100; backdrop-filter: blur(2px); }
        .file-list { max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; margin: 15px 0; }
        .file-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; cursor: pointer; }
        .file-item:hover { background: #f8f9fa; }
        .file-item input { margin-right: 10px; }
        .file-item-name { flex: 1; font-size: 0.9rem; }
        
        .section-title { font-size: 0.95rem; font-weight: 700; color: #495057; margin: 20px 0 10px 0; border-bottom: 2px solid #f1f3f5; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        .section-title:first-child { margin-top: 0; }
        .form-group { margin-bottom: 15px; }
        .form-group input { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 8px; font-size: 0.9rem; }
        
        .custom-model-list { background: #f8f9fa; border: 1px solid #eee; border-radius: 8px; padding: 5px; max-height: 120px; overflow-y: auto; }
        .custom-model-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .btn-del-model { color: #dc3545; background: none; border: none; cursor: pointer; padding: 2px 6px; }

        .modal-footer { text-align: right; margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px; }
        .save-btn { background: #28a745; color: white; border: none; padding: 8px 20px; border-radius: 8px; cursor: pointer; font-weight: 500; }
        .close-btn { background: #e9ecef; color: #495057; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; }
        
        .typing-indicator { font-style: italic; color: #adb5bd; font-size: 0.85rem; margin-bottom: 10px; display: none; padding-left: 20px; }
        #model-list-result { margin-top: 5px; font-size: 0.8rem; background: #eee; padding: 5px; border-radius: 4px; display:none; white-space: pre-wrap;}
    </style>
</head>
<body>

    <div class="main-container">
        <div class="header">
            <div class="header-left">
                <h1>AI èšåˆæ§åˆ¶å° <button class="btn-reset" onclick="hardReset()" title="é‡ç½®">â†º</button></h1>
            </div>
            <div class="header-actions">
                <button class="btn btn-load" onclick="openFileBrowser()">ğŸ“‚ è¼‰å…¥ç« ç¯€</button>
                <button class="btn" onclick="clearHistory()">ğŸ—‘ï¸ æ¸…ç©º</button>
                <button class="btn" onclick="openSettings()">âš™ï¸ è¨­å®š</button>
            </div>
        </div>

        <div id="chat-box"></div>
        <div class="typing-indicator" id="loading-indicator">AI æ­£åœ¨æ€è€ƒä¸­...</div>

        <div class="input-area-wrapper">
            <div class="input-controls">
                <div id="quick-model-btn" onclick="toggleQuickMenu()">
                    <span id="quick-model-dot" class="provider-dot dot-google"></span>
                    <span id="quick-model-name">è¼‰å…¥ä¸­...</span>
                    <span style="font-size: 0.7em; color: #999;">â–¼</span>
                </div>
            </div>

            <div id="quick-model-menu"></div>

            <div class="input-box-container">
                <textarea id="user-input" placeholder="è¼¸å…¥è¨Šæ¯..." rows="1" onkeydown="if(event.keyCode===13 && !event.shiftKey){event.preventDefault(); sendMessage();}"></textarea>
                <button id="send-btn" onclick="sendMessage()">ç™¼é€</button>
            </div>
        </div>
    </div>

    <div id="settings-modal">
        <div class="modal-content">
            <h2>âš™ï¸ ç³»çµ±è¨­å®š</h2>
            
            <div class="section-title">ğŸ“ ç®¡ç†è‡ªè¨‚æ¨¡å‹</div>
            <div class="form-group">
                <div id="custom-model-list-container" class="custom-model-list"></div>
                <div style="margin-top: 10px; display: flex; gap: 5px;">
                    <input type="text" id="new-custom-model" placeholder="è¼¸å…¥ ID (å¦‚ grok-beta)">
                    <button class="btn" onclick="addCustomModel()">æ–°å¢</button>
                </div>
            </div>

            <div class="section-title">ğŸ”µ Google Gemini (å®‰å…¨å·²è§£é–) <button type="button" class="btn" style="font-size:0.7rem; padding:2px 6px;" onclick="checkGoogleModels()">æª¢æ¸¬</button></div>
            <div class="form-group"><input type="password" id="google-key-input" placeholder="Google API Key"><div id="model-list-result"></div></div>

            <div class="section-title">ğŸŸ£ Anthropic Claude</div>
            <div class="form-group"><input type="password" id="claude-key-input" placeholder="sk-ant-..."></div>

            <div class="section-title">ğŸ”´ æ™ºè­œ AI (GLM)</div>
            <div class="form-group"><input type="password" id="zhipu-key-input" placeholder="æ™ºè­œ API Key"></div>

            <div class="section-title">ğŸŸ¢ è¬ç”¨æ¥å£ (OpenAI æ ¼å¼)</div>
            <div class="form-group"><input type="text" id="universal-url" placeholder="https://api.openai.com/v1/chat/completions"></div>
            <div class="form-group"><input type="password" id="universal-key" placeholder="sk-..."></div>

            <div class="section-title">ğŸ™ GitHub å­˜æª”/è®€æª”</div>
            <div class="form-group">
                <input type="password" id="github-token" placeholder="Token">
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <input type="text" id="github-user" placeholder="User ID">
                    <input type="text" id="github-repo" placeholder="Repo Name">
                </div>
            </div>

            <div class="modal-footer">
                <button class="close-btn" onclick="closeSettings()">å–æ¶ˆ</button>
                <button class="save-btn" onclick="saveSettings()">å„²å­˜</button>
            </div>
        </div>
    </div>

    <div id="file-modal">
        <div class="modal-content">
            <h2>ğŸ“‚ é¸æ“‡æ­·å²ç« ç¯€</h2>
            <p style="font-size:0.85rem; color:#666; margin-bottom:10px;">ç³»çµ±å°‡è®€å–æ‰€é¸æª”æ¡ˆå…§å®¹ï¼Œä¸¦æ³¨å…¥åˆ° AI è¨˜æ†¶ä¸­ã€‚</p>
            <div id="repo-file-list" class="file-list">è¼‰å…¥ä¸­...</div>
            <div class="modal-footer">
                <button class="close-btn" onclick="closeFileBrowser()">å–æ¶ˆ</button>
                <button class="save-btn" onclick="loadSelectedFiles()">ç¢ºèªè¼‰å…¥</button>
            </div>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒè®Šæ•¸ ---
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        const quickModelName = document.getElementById('quick-model-name');
        const quickModelDot = document.getElementById('quick-model-dot');
        const quickModelMenu = document.getElementById('quick-model-menu');
        const customModelListContainer = document.getElementById('custom-model-list-container');
        const modelListResult = document.getElementById('model-list-result');
        const repoFileList = document.getElementById('repo-file-list');

        const defaultModels = [
            { id: 'gemini-1.5-flash', name: 'Gemini 1.5 Flash', provider: 'google' },
            { id: 'gemini-1.5-pro', name: 'Gemini 1.5 Pro', provider: 'google' },
            { id: 'gemini-2.0-flash-exp', name: 'Gemini 2.0 Flash (Exp)', provider: 'google' },
            { id: 'claude-3-5-sonnet-20241022', name: 'Claude 3.5 Sonnet', provider: 'claude' },
            { id: 'glm-4-plus', name: 'GLM-4 Plus', provider: 'zhipu' },
            { id: 'grok-beta', name: 'xAI Grok Beta', provider: 'universal' }
        ];

        let history = []; 

        window.onload = function() {
            try {
                loadSettings();
                loadChatHistory();
                renderQuickMenu();
                renderCustomModelList();
                document.addEventListener('click', function(e) {
                    if (!document.getElementById('quick-model-btn').contains(e.target) && !quickModelMenu.contains(e.target)) {
                        quickModelMenu.style.display = 'none';
                    }
                });
            } catch (e) { console.error(e); }
        };

        function hardReset() { if(confirm("é‡ç½®è¨­å®šï¼Ÿ")) { localStorage.clear(); location.reload(); } }

        // --- è¨­å®šç®¡ç† ---
        function loadSettings() {
            document.getElementById('zhipu-key-input').value = localStorage.getItem('zhipu_api_key') || '';
            document.getElementById('google-key-input').value = localStorage.getItem('google_api_key') || '';
            document.getElementById('claude-key-input').value = localStorage.getItem('claude_api_key') || '';
            document.getElementById('universal-url').value = localStorage.getItem('universal_url') || '';
            document.getElementById('universal-key').value = localStorage.getItem('universal_key') || '';
            document.getElementById('github-token').value = localStorage.getItem('github_token') || '';
            document.getElementById('github-user').value = localStorage.getItem('github_user') || '';
            document.getElementById('github-repo').value = localStorage.getItem('github_repo') || '';

            let current = localStorage.getItem('selected_model') || 'gemini-1.5-flash';
            updateQuickBtnUI(current);
        }

        function saveSettings() {
            localStorage.setItem('zhipu_api_key', document.getElementById('zhipu-key-input').value.trim());
            localStorage.setItem('google_api_key', document.getElementById('google-key-input').value.trim());
            localStorage.setItem('claude_api_key', document.getElementById('claude-key-input').value.trim());
            localStorage.setItem('universal_url', document.getElementById('universal-url').value.trim());
            localStorage.setItem('universal_key', document.getElementById('universal-key').value.trim());
            localStorage.setItem('github_token', document.getElementById('github-token').value.trim());
            localStorage.setItem('github_user', document.getElementById('github-user').value.trim());
            localStorage.setItem('github_repo', document.getElementById('github-repo').value.trim());

            renderQuickMenu(); renderCustomModelList();
            updateQuickBtnUI(localStorage.getItem('selected_model'));
            closeSettings();
        }

        // --- æª”æ¡ˆå›è®€ (Context Loader) ---
        async function openFileBrowser() {
            const token = localStorage.getItem('github_token');
            const user = localStorage.getItem('github_user');
            const repo = localStorage.getItem('github_repo');

            if(!token || !user || !repo) { alert("è«‹å…ˆè¨­å®š GitHub è³‡è¨Š"); openSettings(); return; }

            document.getElementById('file-modal').style.display = 'flex';
            repoFileList.innerHTML = 'æ­£åœ¨è®€å– GitHub æª”æ¡ˆåˆ—è¡¨...';

            try {
                // Fetch root files
                const res = await fetch(`https://api.github.com/repos/${user}/${repo}/contents`, {
                    headers: { 'Authorization': `token ${token}` }
                });
                
                if(!res.ok) throw new Error("è®€å–å¤±æ•— (404/403)");
                const data = await res.json();
                
                // Filter .md files
                const mdFiles = data.filter(f => f.name.endsWith('.md')).sort((a,b) => b.name.localeCompare(a.name)); // newest first usually

                repoFileList.innerHTML = '';
                if(mdFiles.length === 0) {
                    repoFileList.innerHTML = '<div style="padding:10px;">æ²’æœ‰æ‰¾åˆ° .md æª”æ¡ˆ</div>';
                    return;
                }

                mdFiles.forEach(file => {
                    const div = document.createElement('div');
                    div.className = 'file-item';
                    div.innerHTML = `
                        <input type="checkbox" value="${file.path}" data-name="${file.name}">
                        <div class="file-item-name">${file.name}</div>
                    `;
                    div.onclick = (e) => {
                        if(e.target.tagName !== 'INPUT') {
                            const cb = div.querySelector('input'); cb.checked = !cb.checked;
                        }
                    };
                    repoFileList.appendChild(div);
                });

            } catch (e) {
                repoFileList.textContent = "è®€å–éŒ¯èª¤: " + e.message;
            }
        }

        function closeFileBrowser() { document.getElementById('file-modal').style.display = 'none'; }

        async function loadSelectedFiles() {
            const checkboxes = repoFileList.querySelectorAll('input:checked');
            if(checkboxes.length === 0) return alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æª”æ¡ˆ");

            const token = localStorage.getItem('github_token');
            const user = localStorage.getItem('github_user');
            const repo = localStorage.getItem('github_repo');

            closeFileBrowser();
            appendMessageToUI('system', `æ­£åœ¨å¾ GitHub ä¸‹è¼‰ ${checkboxes.length} å€‹ç« ç¯€...`);

            let contextBuffer = "";

            for (let cb of checkboxes) {
                const path = cb.value;
                const name = cb.dataset.name;
                
                try {
                    const res = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/${path}`, {
                        headers: { 'Authorization': `token ${token}` }
                    });
                    const data = await res.json();
                    // Decode Base64 content (Github API returns base64)
                    // ä½¿ç”¨ TextDecoder è™•ç†ä¸­æ–‡äº‚ç¢¼
                    const rawContent = atob(data.content.replace(/\n/g, ''));
                    const bytes = new Uint8Array(rawContent.length);
                    for (let i = 0; i < rawContent.length; i++) bytes[i] = rawContent.charCodeAt(i);
                    const text = new TextDecoder('utf-8').decode(bytes);

                    contextBuffer += `\n\n--- [æª”æ¡ˆ: ${name}] ---\n${text}`;
                    
                } catch (e) {
                    appendMessageToUI('system', `âŒ ä¸‹è¼‰ ${name} å¤±æ•—: ${e.message}`);
                }
            }

            if(contextBuffer) {
                // å°‡é€™äº›å…§å®¹æ³¨å…¥åˆ° History ä¸­ï¼Œä½œç‚ºä¸€å€‹ "User" æä¾›çš„èƒŒæ™¯è³‡æ–™
                const injectMsg = `ã€ç³»çµ±æ³¨å…¥ï¼šæ­·å²èƒŒæ™¯è³‡æ–™ã€‘\næˆ‘è¼‰å…¥äº†ä¹‹å‰çš„ç« ç¯€å…§å®¹ï¼Œè«‹åŸºæ–¼é€™äº›å…§å®¹ç¹¼çºŒå‰µä½œï¼š\n${contextBuffer}`;
                
                history.push({ role: "user", content: injectMsg });
                // åŒæ™‚ä¹Ÿå‡è£ AI å·²ç¶“è®€éäº†
                history.push({ role: "assistant", content: "æ”¶åˆ°ï¼Œæˆ‘å·²ç¶“è®€å–äº†ä¸Šè¿°çš„æ­·å²ç« ç¯€å…§å®¹ï¼Œéš¨æ™‚å¯ä»¥ç¹¼çºŒå‰µä½œã€‚" });
                
                saveChatHistory();
                appendMessageToUI('system', `âœ… æˆåŠŸè¼‰å…¥ï¼AI ç¾åœ¨å·²ç¶“è¨˜å¾—é€™äº›ç« ç¯€çš„å…§å®¹äº†ã€‚`);
            }
        }

        // --- è·¯ç”±åˆ¤æ–· (æ ¸å¿ƒé‚è¼¯) ---
        function getProviderByModelId(modelId) {
            if (modelId.includes('gemini')) return 'google';
            if (modelId.includes('claude')) return 'claude';
            if (modelId.startsWith('glm')) return 'zhipu';
            return 'universal'; 
        }

        // --- è¼”åŠ©å‡½å¼ (çœç•¥éƒ¨åˆ†é‡è¤‡ä»£ç¢¼ï¼Œä¿ç•™æ ¸å¿ƒ) ---
        function getCustomModels() { return JSON.parse(localStorage.getItem('custom_models') || '[]'); }
        function addCustomModel() {
            const input = document.getElementById('new-custom-model'); const newId = input.value.trim(); if(!newId) return;
            let list = getCustomModels(); if(list.includes(newId) || defaultModels.some(m=>m.id===newId)) return alert("å·²å­˜åœ¨");
            list.push(newId); localStorage.setItem('custom_models', JSON.stringify(list)); input.value=''; renderCustomModelList(); renderQuickMenu();
        }
        function deleteCustomModel(id) {
            if(!confirm("åˆªé™¤?")) return; let list = getCustomModels().filter(m=>m!==id); localStorage.setItem('custom_models', JSON.stringify(list));
            if(localStorage.getItem('selected_model')===id){localStorage.setItem('selected_model','gemini-1.5-flash');updateQuickBtnUI('gemini-1.5-flash');}
            renderCustomModelList(); renderQuickMenu();
        }
        function renderCustomModelList() {
            const list = getCustomModels(); customModelListContainer.innerHTML = '';
            if(list.length===0){customModelListContainer.innerHTML='<div class="empty-hint">ç„¡è‡ªè¨‚æ¨¡å‹</div>';return;}
            list.forEach(id=>{
                const p = getProviderByModelId(id); const div = document.createElement('div'); div.className = 'custom-model-item';
                div.innerHTML=`<span><span class="provider-dot dot-${p}"></span> ${id}</span> <button class="btn-del-model" onclick="deleteCustomModel('${id}')">ğŸ—‘</button>`;
                customModelListContainer.appendChild(div);
            });
        }
        function toggleQuickMenu() { quickModelMenu.style.display = quickModelMenu.style.display === 'block' ? 'none' : 'block'; }
        function selectModel(id) { localStorage.setItem('selected_model', id); updateQuickBtnUI(id); quickModelMenu.style.display = 'none'; renderQuickMenu(); }
        function updateQuickBtnUI(id) {
            let info = defaultModels.find(m=>m.id===id); let name = info?info.name:id; let provider = getProviderByModelId(id);
            quickModelName.textContent = name; quickModelDot.className = `provider-dot dot-${provider}`;
        }
        function renderQuickMenu() {
            const current = localStorage.getItem('selected_model'); const customList = getCustomModels(); quickModelMenu.innerHTML = '';
            const addGroup = (title, items) => {
                if(items.length===0)return; const h=document.createElement('div');h.className='quick-menu-header';h.textContent=title;quickModelMenu.appendChild(h);
                items.forEach(m=>{
                    const div=document.createElement('div');div.className=`quick-menu-item ${m.id===current?'active':''}`;
                    div.innerHTML=`<span class="provider-dot dot-${m.provider}"></span> ${m.name}`;div.onclick=()=>selectModel(m.id);quickModelMenu.appendChild(div);
                });
            };
            addGroup('Google', defaultModels.filter(m=>m.provider==='google')); addGroup('Claude', defaultModels.filter(m=>m.provider==='claude')); addGroup('Zhipu', defaultModels.filter(m=>m.provider==='zhipu'));
            let univ = defaultModels.filter(m=>m.provider==='universal'); let allCus = customList.map(id=>({id:id,name:id,provider:getProviderByModelId(id)}));
            if(univ.length>0||allCus.length>0){
                const h=document.createElement('div');h.className='quick-menu-header';h.textContent='è‡ªè¨‚ / è¬ç”¨';quickModelMenu.appendChild(h);
                univ.forEach(m=>{const div=document.createElement('div');div.className=`quick-menu-item ${m.id===current?'active':''}`;div.innerHTML=`<span class="provider-dot dot-universal"></span> ${m.name}`;div.onclick=()=>selectModel(m.id);quickModelMenu.appendChild(div);});
                allCus.forEach(m=>{const div=document.createElement('div');div.className=`quick-menu-item ${m.id===current?'active':''}`;div.innerHTML=`<span class="provider-dot dot-${m.provider}"></span> ${m.name}`;div.onclick=()=>selectModel(m.id);quickModelMenu.appendChild(div);});
            }
        }
        async function checkGoogleModels() {
            const apiKey = document.getElementById('google-key-input').value.trim(); if(!apiKey)return alert("è«‹å¡«å…¥Key");
            modelListResult.style.display='block';modelListResult.textContent="æŸ¥è©¢ä¸­...";
            try{const res=await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);if(!res.ok)throw new Error("API Err");const data=await res.json();const list=data.models.filter(m=>m.supportedGenerationMethods?.includes("generateContent")).map(m=>m.name.replace('models/','')).sort();modelListResult.innerHTML="<strong>å¯ç”¨ï¼š</strong><br>"+list.join("<br>");}catch(e){modelListResult.textContent="å¤±æ•—:"+e.message;}
        }

        async function sendMessage() {
            const text = userInput.value.trim(); if(!text) return;
            const currentModel = localStorage.getItem('selected_model') || 'gemini-1.5-flash';
            const provider = getProviderByModelId(currentModel);
            let apiKey, apiUrl;

            if (provider === 'google') { apiKey = localStorage.getItem('google_api_key'); }
            else if (provider === 'claude') { apiKey = localStorage.getItem('claude_api_key'); }
            else if (provider === 'zhipu') { apiKey = localStorage.getItem('zhipu_api_key'); }
            else { apiKey = localStorage.getItem('universal_key'); apiUrl = localStorage.getItem('universal_url'); }
            
            if(!apiKey && provider!=='universal') { alert("è«‹å…ˆè¨­å®š Key"); openSettings(); return; }

            appendMessageToUI('user', text); userInput.value = '';
            history.push({ role: "user", content: text }); saveChatHistory();
            if (history.length > 20) history = history.slice(-20); // é€™è£¡æ³¨æ„ï¼šå¦‚æœæœ‰è¼‰å…¥å¤§é‡ç« ç¯€ï¼Œå¯èƒ½éœ€è¦æ”¾å¯¬é€™å€‹é™åˆ¶ï¼Œæˆ–è€…å°‡ context é–å®šä¸è¢« slice

            loadingIndicator.style.display = 'block'; sendBtn.disabled = true;

            try {
                let aiResponse;
                if (provider === 'google') {
                    const googleHistory = history.map(msg => ({ role: msg.role==='assistant'?'model':'user', parts: [{ text: msg.content }] }));
                    const safetySettings = [{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"}];
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${currentModel}:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ contents: googleHistory, safetySettings: safetySettings })
                    });
                    if(!res.ok) throw new Error((await res.json()).error?.message||res.status);
                    aiResponse = (await res.json()).candidates?.[0]?.content?.parts?.[0]?.text;
                } else if (provider === 'claude') {
                    const claudeHistory = history.filter(m=>m.role!=='system');
                    const res = await fetch("https://api.anthropic.com/v1/messages", {
                        method: 'POST', headers: {'x-api-key':apiKey,'anthropic-version':'2023-06-01','content-type':'application/json','dangerously-allow-browser':'true'},
                        body: JSON.stringify({ model: currentModel, max_tokens: 4096, messages: claudeHistory })
                    });
                    if(!res.ok) throw new Error((await res.json()).error?.message||res.status);
                    aiResponse = (await res.json()).content[0].text;
                } else {
                    const endpoint = provider === 'zhipu' ? "https://open.bigmodel.cn/api/paas/v4/chat/completions" : apiUrl;
                    const res = await fetch(endpoint, {
                        method: 'POST', headers: {'Content-Type':'application/json','Authorization':`Bearer ${apiKey}`},
                        body: JSON.stringify({ model: currentModel, messages: history })
                    });
                    if(!res.ok) throw new Error((await res.json()).error?.message||res.status);
                    aiResponse = (await res.json()).choices[0].message.content;
                }
                if (!aiResponse) throw new Error("ç„¡å…§å®¹");
                appendMessageToUI('ai', aiResponse); history.push({ role: "assistant", content: aiResponse }); saveChatHistory();
            } catch (error) { appendMessageToUI('ai', `âŒ éŒ¯èª¤ï¼š${error.message}`); } 
            finally { loadingIndicator.style.display = 'none'; sendBtn.disabled = false; userInput.focus(); }
        }

        function appendMessageToUI(role, text) {
            const container = document.createElement('div'); container.className = `message-container ${role}`;
            const msgDiv = document.createElement('div'); msgDiv.className = `message ${role}`;
            if (typeof marked !== 'undefined' && role!=='system') msgDiv.innerHTML = marked.parse(text); else msgDiv.textContent = text;
            container.appendChild(msgDiv);
            if (role === 'ai') {
                const btn = document.createElement('button'); btn.className = 'github-btn'; btn.innerHTML = `<span>ğŸ“¤ GitHub</span>`;
                btn.onclick = () => uploadToGitHub(text); container.appendChild(btn);
            }
            chatBox.appendChild(container); chatBox.scrollTop = chatBox.scrollHeight;
        }
        async function uploadToGitHub(content) {
            const token=localStorage.getItem('github_token'),user=localStorage.getItem('github_user'),repo=localStorage.getItem('github_repo');
            if(!token||!user||!repo){alert('è«‹è¨­å®šGitHub');openSettings();return;}
            const filename=prompt("æª”å:",`ai-note-${new Date().toISOString().slice(0,19).replace(/[:.]/g,'-')}.md`);if(!filename)return;
            try{const res=await fetch(`https://api.github.com/repos/${user}/${repo}/contents/${filename}`,{method:'PUT',headers:{'Authorization':`token ${token}`,'Content-Type':'application/json'},body:JSON.stringify({message:`Create ${filename}`,content:btoa(unescape(encodeURIComponent(content)))})});
            if(res.ok)alert("âœ… æˆåŠŸ");else alert("âŒ å¤±æ•—");}catch(e){alert("âŒ éŒ¯èª¤");}
        }
        function openSettings() { renderCustomModelList(); document.getElementById('settings-modal').style.display = 'flex'; }
        function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
        function loadChatHistory() { try{const h=JSON.parse(localStorage.getItem('chat_history_v13')||'[]');history=h;chatBox.innerHTML='';h.forEach(m=>appendMessageToUI(m.role,m.content));}catch(e){history=[];} }
        function saveChatHistory() { localStorage.setItem('chat_history_v13', JSON.stringify(history)); }
        function clearHistory() { if(confirm('æ¸…ç©ºï¼Ÿ')) { history=[]; localStorage.removeItem('chat_history_v13'); chatBox.innerHTML=''; } }
    </script>
</body>
</html>